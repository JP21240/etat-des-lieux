<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <title>√âtat des lieux</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    @media print {
      .no-print { display: none !important; }
      thead { display: table-header-group !important; }
      tr { page-break-inside: avoid !important; }
      .signatures-block { page-break-inside: avoid !important; }
    }
    .dictation-active { background-color: #fef9c3 !important; border-color: #f59e0b !important; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef, createContext, useContext, useCallback, memo } = React;

    // ==========================================
    // CONTEXTE GLOBAL
    // ==========================================
    const AppContext = createContext(null);

    // ==========================================
    // CONSTANTES
    // ==========================================
    const ETAT_OPTIONS = ['Bon', 'Appropri√©', 'Mauvais', 'N/A'];
    const OUI_NON = ['Oui', 'Non'];

    // ==========================================
    // TEMPLATE PAR D√âFAUT
    // ==========================================
    const defaultTemplate = {
      nom: 'Appartement Standard',
      pieces: {
        entree: {
          nom: 'Entr√©e', ordre: 1,
          etatLieux: [
            { id: 'rev_sol', nom: 'Rev√™tement de sol' },
            { id: 'plinthes', nom: 'Plinthes' },
            { id: 'murs', nom: 'Murs et plafond' },
            { id: 'porte', nom: 'Porte d\'entr√©e' },
            { id: 'interrupteurs', nom: 'Interrupteurs et prises' },
            { id: 'luminaires', nom: 'Luminaires' },
          ],
          inventaire: [
            { id: 'detecteur', nom: 'D√©tecteur de fum√©e', qte: 1 },
            { id: 'interphone', nom: 'Interphone', qte: 1 },
          ],
        },
        salon: {
          nom: 'Salon', ordre: 2,
          etatLieux: [
            { id: 'rev_sol', nom: 'Rev√™tement de sol' },
            { id: 'murs', nom: 'Murs et plafond' },
            { id: 'fenetre', nom: 'Fen√™tre - volet' },
            { id: 'portes', nom: 'Porte(s)' },
            { id: 'interrupteurs', nom: 'Interrupteurs et prises' },
            { id: 'luminaires', nom: 'Luminaires' },
          ],
          inventaire: [],
        },
        cuisine: {
          nom: 'Cuisine', ordre: 3,
          etatLieux: [
            { id: 'rev_sol', nom: 'Rev√™tement de sol' },
            { id: 'murs', nom: 'Murs et plafond' },
            { id: 'fenetre', nom: 'Fen√™tre' },
            { id: 'evier', nom: '√âvier et robinetterie' },
            { id: 'plan_travail', nom: 'Plan de travail' },
            { id: 'meubles', nom: 'Meubles' },
          ],
          inventaire: [
            { id: 'frigo', nom: 'R√©frig√©rateur', qte: 1 },
            { id: 'plaque', nom: 'Plaques de cuisson', qte: 1 },
            { id: 'four', nom: 'Four', qte: 1 },
            { id: 'hotte', nom: 'Hotte', qte: 1 },
          ],
        },
        chambre: {
          nom: 'Chambre', ordre: 4,
          etatLieux: [
            { id: 'rev_sol', nom: 'Rev√™tement de sol' },
            { id: 'murs', nom: 'Murs et plafond' },
            { id: 'fenetre', nom: 'Fen√™tre - volet' },
            { id: 'placard', nom: 'Placard' },
            { id: 'porte', nom: 'Porte' },
            { id: 'interrupteurs', nom: 'Interrupteurs et prises' },
          ],
          inventaire: [],
        },
        sdb: {
          nom: 'Salle de bain', ordre: 5,
          etatLieux: [
            { id: 'rev_sol', nom: 'Rev√™tement de sol' },
            { id: 'murs', nom: 'Murs et plafond' },
            { id: 'douche', nom: 'Douche / Baignoire' },
            { id: 'lavabo', nom: 'Lavabo' },
            { id: 'wc', nom: 'WC' },
            { id: 'ventilation', nom: 'Ventilation' },
          ],
          inventaire: [
            { id: 'miroir', nom: 'Miroir', qte: 1 },
            { id: 'seche_serviette', nom: 'S√®che-serviettes', qte: 1 },
          ],
        },
      },
      cles: [
        { id: 'entree', nom: 'Cl√© porte d\'entr√©e', qte: 2 },
        { id: 'boite', nom: 'Cl√© bo√Æte aux lettres', qte: 1 },
        { id: 'cave', nom: 'Cl√© cave', qte: 1 },
      ],
    };

    // ==========================================
    // UTILITAIRES
    // ==========================================
    const deepClone = (obj) => JSON.parse(JSON.stringify(obj));

    const templateToData = (template, type = 'Entr√©e') => {
      const pieces = {};
      Object.entries(template.pieces).forEach(([key, piece]) => {
        pieces[key] = {
          ...piece,
          etatLieux: piece.etatLieux.map(item => ({ ...item, etat: '', commentaire: '', photos: [] })),
          inventaire: piece.inventaire.map(item => ({ ...item, etat: '', commentaire: '', photos: [] })),
        };
      });
      return {
        info: { type, proprietaire: '', locataire: '', date: new Date().toISOString().split('T')[0], adresse: '', appartement: template.nom },
        pieces,
        cles: template.cles.map(cle => ({ ...cle, rendue: '', commentaire: '', photos: [] })),
        signatures: { locataire: '', proprietaire: '' },
      };
    };

    // ==========================================
    // SYST√àME DE DICT√âE VOCALE (100% DOM)
    // ==========================================
    window.dictationSystem = {
      recognition: null,
      currentInputId: null,
      
      start: function(inputId, onComplete) {
        const input = document.getElementById(inputId);
        const btn = document.getElementById('btn-' + inputId);
        if (!input) return;
        
        if (this.recognition && this.currentInputId === inputId) {
          this.recognition.stop();
          return;
        }
        
        if (this.recognition) {
          this.recognition.stop();
        }
        
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
          alert('Dict√©e vocale non support√©e. Utilisez Chrome ou Safari.');
          return;
        }
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        this.recognition = new SpeechRecognition();
        this.currentInputId = inputId;
        
        this.recognition.lang = 'fr-FR';
        this.recognition.continuous = true;
        this.recognition.interimResults = true;
        
        const startValue = input.value || '';
        let accumulatedText = '';
        
        this.recognition.onstart = () => {
          input.classList.add('dictation-active');
          if (btn) {
            btn.innerHTML = '‚èπ';
            btn.style.backgroundColor = '#ef4444';
            btn.style.color = 'white';
          }
        };
        
        this.recognition.onresult = (event) => {
          let finalText = '';
          let interimText = '';
          
          for (let i = 0; i < event.results.length; i++) {
            if (event.results[i].isFinal) {
              finalText += event.results[i][0].transcript;
            } else {
              interimText += event.results[i][0].transcript;
            }
          }
          
          accumulatedText = finalText;
          const sep = startValue && !startValue.endsWith(' ') ? ' ' : '';
          input.value = startValue + sep + accumulatedText + interimText;
        };
        
        this.recognition.onend = () => {
          input.classList.remove('dictation-active');
          if (btn) {
            btn.innerHTML = 'üé§';
            btn.style.backgroundColor = '';
            btn.style.color = '';
          }
          
          const finalValue = input.value;
          this.recognition = null;
          this.currentInputId = null;
          
          if (onComplete) {
            onComplete(finalValue);
          }
        };
        
        this.recognition.onerror = () => {
          input.classList.remove('dictation-active');
          if (btn) {
            btn.innerHTML = 'üé§';
            btn.style.backgroundColor = '';
            btn.style.color = '';
          }
          this.recognition = null;
          this.currentInputId = null;
        };
        
        this.recognition.start();
      }
    };

    // ==========================================
    // COMPOSANTS D√âFINIS EN DEHORS DE APP
    // ==========================================
    
    const Icon = memo(({ name, size = 20, className = "" }) => {
      const ref = useRef(null);
      useEffect(() => {
        if (ref.current && lucide[name]) {
          ref.current.innerHTML = '';
          const svg = lucide.createElement(lucide[name]);
          svg.setAttribute('width', size);
          svg.setAttribute('height', size);
          if (className) svg.setAttribute('class', className);
          ref.current.appendChild(svg);
        }
      }, [name, size, className]);
      return <span ref={ref} className={`inline-flex ${className}`} />;
    });

    const EtatButton = memo(({ value, selected, onClick }) => (
      <button 
        type="button"
        onClick={() => onClick(value)} 
        className={`px-2 py-1 text-xs rounded-lg border transition-all ${
          selected 
            ? value === 'Bon' ? 'bg-green-500 text-white' 
            : value === 'Appropri√©' ? 'bg-yellow-500 text-white' 
            : value === 'Mauvais' ? 'bg-red-500 text-white' 
            : 'bg-gray-500 text-white' 
            : 'bg-white text-gray-700 border-gray-300'
        }`}
      >
        {value}
      </button>
    ));

    // Composant Input 100% DOM - React ne g√®re QUE le conteneur
    const CommentInput = memo(({ inputId, initialValue, onSave }) => {
      const containerRef = useRef(null);
      const callbackRef = useRef(onSave);
      
      // Toujours garder le callback √† jour
      callbackRef.current = onSave;
      
      // Cr√©er l'input en JavaScript pur UNE SEULE FOIS
      useEffect(() => {
        const container = containerRef.current;
        if (!container || container.dataset.created) return;
        
        container.dataset.created = 'true';
        container.className = 'flex gap-1 mb-2';
        
        // Cr√©er l'input
        const input = document.createElement('input');
        input.type = 'text';
        input.id = inputId;
        input.placeholder = 'Commentaire...';
        input.value = initialValue || '';
        input.className = 'flex-1 text-sm p-2 border rounded-lg';
        input.autocomplete = 'off';
        
        input.addEventListener('blur', () => {
          if (callbackRef.current) {
            callbackRef.current(input.value);
          }
        });
        
        // Cr√©er le bouton micro
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.id = 'btn-' + inputId;
        btn.innerHTML = 'üé§';
        btn.className = 'px-3 rounded-lg border text-lg bg-gray-100 hover:bg-gray-200';
        
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          window.dictationSystem.start(inputId, (value) => {
            if (callbackRef.current) {
              callbackRef.current(value);
            }
          });
        });
        
        container.appendChild(input);
        container.appendChild(btn);
      }, []);
      
      // Retourner juste un div vide que React ne touchera plus
      return <div ref={containerRef} />;
    }, () => true); // Ne JAMAIS re-render

    const PhotoGallery = memo(({ photos, onRemove, inputId, onAddPhoto, onPhotoClick }) => (
      <div className="mt-2 flex flex-wrap gap-2">
        {photos.map((photo) => (
          <div key={photo.id} className="relative">
            <img src={photo.data} alt="" className="w-14 h-14 object-cover rounded-lg border cursor-pointer" onClick={() => onPhotoClick(photo)} />
            <button type="button" onClick={() => onRemove(photo.id)} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 text-xs flex items-center justify-center">√ó</button>
          </div>
        ))}
        <label htmlFor={inputId} className="w-14 h-14 border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-blue-400">
          <Icon name="Camera" size={16} className="text-gray-400" />
          <span className="text-xs text-gray-400">Photo</span>
        </label>
        <input type="file" id={inputId} accept="image/*" capture="environment" multiple className="hidden" onChange={onAddPhoto} />
      </div>
    ));

    const EtatLieuxItem = memo(({ pieceKey, item }) => {
      const { updateEtatLieux, handlePhotoCapture, setSelectedPhoto } = useContext(AppContext);
      
      const handleEtatChange = useCallback((v) => updateEtatLieux(pieceKey, item.id, 'etat', v), [pieceKey, item.id]);
      const handleCommentSave = useCallback((v) => updateEtatLieux(pieceKey, item.id, 'commentaire', v), [pieceKey, item.id]);
      const handlePhotoRemove = useCallback((pid) => updateEtatLieux(pieceKey, item.id, 'photos', item.photos.filter(p => p.id !== pid)), [pieceKey, item.id, item.photos]);
      const handleAddPhoto = useCallback((e) => handlePhotoCapture(e, (p) => updateEtatLieux(pieceKey, item.id, 'photos', p), item.photos), [pieceKey, item.id, item.photos]);
      
      return (
        <div className="bg-gray-50 p-3 rounded-lg">
          <div className="flex items-center justify-between mb-2">
            <span className="font-medium text-sm">{item.nom}</span>
            {item.photos.length > 0 && <span className="text-xs text-blue-600">üì∑ {item.photos.length}</span>}
          </div>
          <div className="flex flex-wrap gap-1 mb-2">
            {ETAT_OPTIONS.map(opt => <EtatButton key={opt} value={opt} selected={item.etat === opt} onClick={handleEtatChange} />)}
          </div>
          <CommentInput inputId={`cmt-e-${pieceKey}-${item.id}`} initialValue={item.commentaire} onSave={handleCommentSave} />
          <PhotoGallery photos={item.photos} onRemove={handlePhotoRemove} inputId={`p-e-${pieceKey}-${item.id}`} onAddPhoto={handleAddPhoto} onPhotoClick={setSelectedPhoto} />
        </div>
      );
    });

    const InventaireItem = memo(({ pieceKey, item }) => {
      const { updateInventaire, handlePhotoCapture, setSelectedPhoto } = useContext(AppContext);
      const qteRef = useRef(null);
      
      useEffect(() => { if (qteRef.current && !qteRef.current.dataset.init) { qteRef.current.value = item.qte; qteRef.current.dataset.init = '1'; } }, []);
      
      const handleEtatChange = useCallback((v) => updateInventaire(pieceKey, item.id, 'etat', v), [pieceKey, item.id]);
      const handleCommentSave = useCallback((v) => updateInventaire(pieceKey, item.id, 'commentaire', v), [pieceKey, item.id]);
      const handleQteBlur = useCallback(() => { if (qteRef.current) updateInventaire(pieceKey, item.id, 'qte', parseInt(qteRef.current.value) || 0); }, [pieceKey, item.id]);
      const handlePhotoRemove = useCallback((pid) => updateInventaire(pieceKey, item.id, 'photos', item.photos.filter(p => p.id !== pid)), [pieceKey, item.id, item.photos]);
      const handleAddPhoto = useCallback((e) => handlePhotoCapture(e, (p) => updateInventaire(pieceKey, item.id, 'photos', p), item.photos), [pieceKey, item.id, item.photos]);
      
      return (
        <div className="bg-gray-50 p-3 rounded-lg">
          <div className="flex items-center justify-between mb-2">
            <span className="font-medium text-sm">{item.nom}</span>
            <div className="flex items-center gap-2">
              <span className="text-xs text-gray-500">Qt√©:</span>
              <input ref={qteRef} type="number" min="0" onBlur={handleQteBlur} className="w-12 text-center text-sm p-1 border rounded" />
            </div>
          </div>
          <div className="flex flex-wrap gap-1 mb-2">
            {ETAT_OPTIONS.map(opt => <EtatButton key={opt} value={opt} selected={item.etat === opt} onClick={handleEtatChange} />)}
          </div>
          <CommentInput inputId={`cmt-i-${pieceKey}-${item.id}`} initialValue={item.commentaire} onSave={handleCommentSave} />
          <PhotoGallery photos={item.photos} onRemove={handlePhotoRemove} inputId={`p-i-${pieceKey}-${item.id}`} onAddPhoto={handleAddPhoto} onPhotoClick={setSelectedPhoto} />
        </div>
      );
    });

    const PieceSection = memo(({ pieceKey, piece, isExpanded, onToggle }) => {
      const photoCount = [...piece.etatLieux, ...piece.inventaire].reduce((a, i) => a + i.photos.length, 0);
      return (
        <div className="mb-3 bg-white rounded-xl shadow-sm border overflow-hidden">
          <button type="button" onClick={onToggle} className="w-full flex items-center justify-between p-4 bg-gradient-to-r from-blue-50 to-indigo-50">
            <div className="flex items-center gap-2">
              <span className="font-semibold text-gray-800">{piece.nom}</span>
              {photoCount > 0 && <span className="bg-blue-100 text-blue-700 text-xs px-2 py-0.5 rounded-full">üì∑ {photoCount}</span>}
            </div>
            <Icon name={isExpanded ? "ChevronUp" : "ChevronDown"} size={20} />
          </button>
          {isExpanded && (
            <div className="p-3 space-y-4">
              {piece.etatLieux.length > 0 && (
                <div>
                  <h4 className="font-medium text-sm text-blue-700 mb-2">üè† √âtat des lieux</h4>
                  <div className="space-y-3">
                    {piece.etatLieux.map(item => <EtatLieuxItem key={item.id} pieceKey={pieceKey} item={item} />)}
                  </div>
                </div>
              )}
              {piece.inventaire.length > 0 && (
                <div>
                  <h4 className="font-medium text-sm text-green-700 mb-2">üìã Inventaire</h4>
                  <div className="space-y-3">
                    {piece.inventaire.map(item => <InventaireItem key={item.id} pieceKey={pieceKey} item={item} />)}
                  </div>
                </div>
              )}
            </div>
          )}
        </div>
      );
    });

    const CleItem = memo(({ cle }) => {
      const { updateCle, handlePhotoCapture, setSelectedPhoto } = useContext(AppContext);
      const qteRef = useRef(null);
      
      useEffect(() => { if (qteRef.current && !qteRef.current.dataset.init) { qteRef.current.value = cle.qte; qteRef.current.dataset.init = '1'; } }, []);
      
      const handleCommentSave = useCallback((v) => updateCle(cle.id, 'commentaire', v), [cle.id]);
      const handleQteBlur = useCallback(() => { if (qteRef.current) updateCle(cle.id, 'qte', parseInt(qteRef.current.value) || 0); }, [cle.id]);
      const handlePhotoRemove = useCallback((pid) => updateCle(cle.id, 'photos', cle.photos.filter(p => p.id !== pid)), [cle.id, cle.photos]);
      const handleAddPhoto = useCallback((e) => handlePhotoCapture(e, (p) => updateCle(cle.id, 'photos', p), cle.photos), [cle.id, cle.photos]);
      
      return (
        <div className="bg-gray-50 p-3 rounded-lg">
          <div className="flex items-center justify-between mb-2">
            <span className="font-medium">{cle.nom}</span>
            <div className="flex items-center gap-2">
              <span className="text-xs">Qt√©:</span>
              <input ref={qteRef} type="number" min="0" onBlur={handleQteBlur} className="w-12 text-center text-sm p-1 border rounded" />
            </div>
          </div>
          <div className="flex gap-2 mb-2">
            <span className="text-sm">Rendue:</span>
            {OUI_NON.map(opt => (
              <button key={opt} type="button" onClick={() => updateCle(cle.id, 'rendue', opt)} className={`px-3 py-1 text-sm rounded-lg border ${cle.rendue === opt ? opt === 'Oui' ? 'bg-green-500 text-white' : 'bg-red-500 text-white' : 'bg-white'}`}>{opt}</button>
            ))}
          </div>
          <CommentInput inputId={`cmt-c-${cle.id}`} initialValue={cle.commentaire} onSave={handleCommentSave} />
          <PhotoGallery photos={cle.photos} onRemove={handlePhotoRemove} inputId={`p-c-${cle.id}`} onAddPhoto={handleAddPhoto} onPhotoClick={setSelectedPhoto} />
        </div>
      );
    });

    const TabButton = memo(({ id, icon, label, active, badge, onClick }) => (
      <button type="button" onClick={() => onClick(id)} className={`flex flex-col items-center justify-center p-2 flex-1 transition-all relative ${active ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' : 'text-gray-500'}`}>
        <Icon name={icon} size={20} />
        <span className="text-xs mt-1">{label}</span>
        {badge > 0 && <span className="absolute top-1 right-1/4 bg-red-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center">{badge > 9 ? '9+' : badge}</span>}
      </button>
    ));

    // ==========================================
    // APPLICATION PRINCIPALE
    // ==========================================
    function App() {
      const [templates, setTemplates] = useState(() => {
        try { const s = localStorage.getItem('edl_templates'); return s ? JSON.parse(s) : { 'default': defaultTemplate }; } catch { return { 'default': defaultTemplate }; }
      });
      const [currentTemplate, setCurrentTemplate] = useState('default');
      const [data, setData] = useState(() => templateToData(defaultTemplate));
      const [activeTab, setActiveTab] = useState('info');
      const [expandedPiece, setExpandedPiece] = useState(null);
      const [showPrint, setShowPrint] = useState(false);
      const [selectedPhoto, setSelectedPhoto] = useState(null);
      const [showConfig, setShowConfig] = useState(false);
      const [savedEdls, setSavedEdls] = useState(() => {
        try { const s = localStorage.getItem('edl_saved'); return s ? JSON.parse(s) : []; } catch { return []; }
      });
      const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);

      useEffect(() => { try { localStorage.setItem('edl_templates', JSON.stringify(templates)); } catch {} }, [templates]);
      useEffect(() => { try { localStorage.setItem('edl_saved', JSON.stringify(savedEdls)); } catch {} }, [savedEdls]);

      const updateInfo = useCallback((f, v) => setData(p => ({ ...p, info: { ...p.info, [f]: v } })), []);
      const updateEtatLieux = useCallback((pk, iid, f, v) => setData(p => ({ ...p, pieces: { ...p.pieces, [pk]: { ...p.pieces[pk], etatLieux: p.pieces[pk].etatLieux.map(i => i.id === iid ? { ...i, [f]: v } : i) } } })), []);
      const updateInventaire = useCallback((pk, iid, f, v) => setData(p => ({ ...p, pieces: { ...p.pieces, [pk]: { ...p.pieces[pk], inventaire: p.pieces[pk].inventaire.map(i => i.id === iid ? { ...i, [f]: v } : i) } } })), []);
      const updateCle = useCallback((cid, f, v) => setData(p => ({ ...p, cles: p.cles.map(c => c.id === cid ? { ...c, [f]: v } : c) })), []);
      const updateSignature = useCallback((w, v) => setData(p => ({ ...p, signatures: { ...p.signatures, [w]: v } })), []);

      const handlePhotoCapture = useCallback(async (e, setPhotos, curr) => {
        const files = Array.from(e.target.files);
        const newP = [];
        for (const f of files) {
          const r = new FileReader();
          const d = await new Promise(res => { r.onload = ev => res(ev.target.result); r.readAsDataURL(f); });
          newP.push({ id: Date.now() + Math.random(), data: d });
        }
        setPhotos([...curr, ...newP]);
        e.target.value = '';
      }, []);

      const loadTemplate = useCallback((tk) => { setCurrentTemplate(tk); setData(templateToData(templates[tk])); setExpandedPiece(null); }, [templates]);
      const countPhotos = useCallback(() => { let t = 0; Object.values(data.pieces).forEach(p => { p.etatLieux.forEach(i => t += i.photos.length); p.inventaire.forEach(i => t += i.photos.length); }); data.cles.forEach(c => t += c.photos.length); return t; }, [data]);
      const totalPhotos = countPhotos();
      const sortedPieces = Object.entries(data.pieces).sort((a, b) => (a[1].ordre || 0) - (b[1].ordre || 0));

      const resetEdl = useCallback(() => { if (window.confirm('R√©initialiser ?')) { setData(templateToData(templates[currentTemplate])); setExpandedPiece(null); } }, [templates, currentTemplate]);
      const saveEdl = useCallback(() => { const n = prompt('Nom:', `EDL ${data.info.locataire || ''} - ${data.info.date}`); if (n) { setSavedEdls(p => [...p, { id: Date.now(), name: n, data: deepClone(data), date: new Date().toISOString() }]); alert('Sauvegard√© !'); } }, [data]);
      const loadEdl = useCallback((e) => { if (window.confirm(`Charger "${e.name}" ?`)) { setData(deepClone(e.data)); setExpandedPiece(null); } }, []);
      const deleteEdl = useCallback((id) => { if (window.confirm('Supprimer ?')) setSavedEdls(p => p.filter(e => e.id !== id)); }, []);

      const generatePDF = useCallback(async () => {
        setIsGeneratingPdf(true); setShowPrint(true);
        await new Promise(r => setTimeout(r, 500));
        const el = document.getElementById('print-content');
        if (el && window.html2pdf) {
          await window.html2pdf().set({
            margin: [10, 10, 15, 10],
            filename: `EDL_${data.info.type}_${data.info.locataire || 'locataire'}_${data.info.date}.pdf`,
            image: { type: 'jpeg', quality: 0.95 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
          }).from(el).save();
        }
        setShowPrint(false); setIsGeneratingPdf(false);
      }, [data]);

      const ctx = { updateEtatLieux, updateInventaire, updateCle, handlePhotoCapture, setSelectedPhoto };

      return (
        <AppContext.Provider value={ctx}>
          <div className="min-h-screen bg-gray-100 pb-20">
            <div className="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 sticky top-0 z-50 no-print">
              <div className="flex items-center justify-between">
                <h1 className="text-lg font-bold">üìã √âtat des lieux</h1>
                <div className="flex gap-2">
                  <button type="button" onClick={resetEdl} className="p-2 bg-white/20 rounded-lg">üîÑ</button>
                  <button type="button" onClick={saveEdl} className="p-2 bg-white/20 rounded-lg">üíæ</button>
                  <button type="button" onClick={() => setShowConfig(true)} className="p-2 bg-white/20 rounded-lg">‚öôÔ∏è</button>
                  <button type="button" onClick={generatePDF} className="p-2 bg-white/20 rounded-lg">üìÑ</button>
                </div>
              </div>
            </div>

            <div className="p-4">
              {activeTab === 'info' && (
                <div className="bg-white rounded-xl p-4 shadow-sm space-y-4">
                  <h2 className="font-semibold text-lg mb-4">üìù Informations</h2>
                  <div className="flex gap-2">
                    {['Entr√©e', 'Sortie'].map(t => (
                      <button key={t} type="button" onClick={() => updateInfo('type', t)} className={`flex-1 py-3 rounded-lg border-2 font-medium ${data.info.type === t ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-gray-200'}`}>{t}</button>
                    ))}
                  </div>
                  <div><label className="block text-sm font-medium mb-1">Mod√®le</label><select value={currentTemplate} onChange={e => loadTemplate(e.target.value)} className="w-full p-3 border rounded-lg">{Object.entries(templates).map(([k, t]) => <option key={k} value={k}>{t.nom}</option>)}</select></div>
                  <div><label className="block text-sm font-medium mb-1">Propri√©taire</label><input type="text" defaultValue={data.info.proprietaire} onBlur={e => updateInfo('proprietaire', e.target.value)} className="w-full p-3 border rounded-lg" /></div>
                  <div><label className="block text-sm font-medium mb-1">Locataire</label><input type="text" defaultValue={data.info.locataire} onBlur={e => updateInfo('locataire', e.target.value)} className="w-full p-3 border rounded-lg" /></div>
                  <div><label className="block text-sm font-medium mb-1">Date</label><input type="date" defaultValue={data.info.date} onBlur={e => updateInfo('date', e.target.value)} className="w-full p-3 border rounded-lg" /></div>
                  <div><label className="block text-sm font-medium mb-1">Adresse</label><textarea defaultValue={data.info.adresse} onBlur={e => updateInfo('adresse', e.target.value)} rows={2} className="w-full p-3 border rounded-lg" /></div>
                  {savedEdls.length > 0 && (
                    <div className="mt-6 pt-4 border-t">
                      <h3 className="font-medium mb-3">üìÇ Sauvegard√©s</h3>
                      <div className="space-y-2">
                        {savedEdls.map(edl => (
                          <div key={edl.id} className="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                            <div><div className="font-medium text-sm">{edl.name}</div><div className="text-xs text-gray-500">{new Date(edl.date).toLocaleDateString('fr-FR')}</div></div>
                            <div className="flex gap-2">
                              <button type="button" onClick={() => loadEdl(edl)} className="px-3 py-1 bg-blue-500 text-white rounded text-sm">Charger</button>
                              <button type="button" onClick={() => deleteEdl(edl.id)} className="px-3 py-1 bg-red-500 text-white rounded text-sm">üóëÔ∏è</button>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              )}

              {activeTab === 'pieces' && (
                <div>{sortedPieces.map(([pk, p]) => <PieceSection key={pk} pieceKey={pk} piece={p} isExpanded={expandedPiece === pk} onToggle={() => setExpandedPiece(expandedPiece === pk ? null : pk)} />)}</div>
              )}

              {activeTab === 'cles' && (
                <div className="bg-white rounded-xl p-4 shadow-sm">
                  <h2 className="font-semibold text-lg mb-4">üîë Cl√©s</h2>
                  <div className="space-y-4">{data.cles.map(c => <CleItem key={c.id} cle={c} />)}</div>
                </div>
              )}

              {activeTab === 'signature' && (
                <div className="bg-white rounded-xl p-4 shadow-sm">
                  <h2 className="font-semibold text-lg mb-4">‚úÖ Validation</h2>
                  <div className="space-y-4">
                    <div><label className="block text-sm font-medium mb-2">Locataire</label><input type="text" defaultValue={data.signatures.locataire} onBlur={e => updateSignature('locataire', e.target.value)} placeholder="Nom" className="w-full p-3 border rounded-lg text-center" /></div>
                    <div><label className="block text-sm font-medium mb-2">Propri√©taire</label><input type="text" defaultValue={data.signatures.proprietaire} onBlur={e => updateSignature('proprietaire', e.target.value)} placeholder="Nom" className="w-full p-3 border rounded-lg text-center" /></div>
                    <button type="button" onClick={generatePDF} disabled={isGeneratingPdf} className="w-full py-4 bg-green-600 text-white rounded-xl font-semibold text-lg disabled:opacity-50">{isGeneratingPdf ? '...' : 'üìÑ G√©n√©rer le PDF'}</button>
                  </div>
                </div>
              )}
            </div>

            <div className="fixed bottom-0 left-0 right-0 bg-white border-t flex shadow-lg z-40 no-print">
              <TabButton id="info" icon="FileText" label="Infos" active={activeTab === 'info'} onClick={setActiveTab} />
              <TabButton id="pieces" icon="Home" label="Pi√®ces" active={activeTab === 'pieces'} badge={totalPhotos} onClick={setActiveTab} />
              <TabButton id="cles" icon="Key" label="Cl√©s" active={activeTab === 'cles'} onClick={setActiveTab} />
              <TabButton id="signature" icon="Check" label="Valider" active={activeTab === 'signature'} onClick={setActiveTab} />
            </div>

            {selectedPhoto && (
              <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4" onClick={() => setSelectedPhoto(null)}>
                <img src={selectedPhoto.data} alt="" className="max-w-full max-h-full object-contain" />
                <button type="button" className="absolute top-4 right-4 text-white text-3xl" onClick={() => setSelectedPhoto(null)}>√ó</button>
              </div>
            )}

            {showConfig && (
              <div className="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center">
                <div className="bg-white w-full sm:max-w-lg sm:rounded-xl max-h-[90vh] overflow-auto">
                  <div className="sticky top-0 bg-white p-4 border-b flex justify-between items-center">
                    <h2 className="font-bold text-lg">‚öôÔ∏è Configuration</h2>
                    <button type="button" onClick={() => setShowConfig(false)} className="text-2xl">√ó</button>
                  </div>
                  <div className="p-4">
                    <p className="text-gray-600 mb-4">Mod√®les: {Object.keys(templates).length}</p>
                    <div className="flex gap-2">
                      <button type="button" onClick={() => { const b = new Blob([JSON.stringify(templates, null, 2)], { type: 'application/json' }); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = 'modeles.json'; a.click(); }} className="flex-1 py-2 bg-blue-600 text-white rounded-lg">üì§ Exporter</button>
                      <label className="flex-1"><div className="py-2 bg-green-600 text-white rounded-lg text-center cursor-pointer">üì• Importer</div><input type="file" accept=".json" className="hidden" onChange={e => { const f = e.target.files[0]; if (f) { const r = new FileReader(); r.onload = ev => { try { setTemplates(p => ({ ...p, ...JSON.parse(ev.target.result) })); alert('OK!'); } catch { alert('Erreur'); } }; r.readAsText(f); } }} /></label>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {showPrint && (
              <div id="print-content" style={{ position: 'absolute', left: '-9999px', top: 0, width: '210mm', background: 'white', padding: '10mm' }}>
                <div style={{ textAlign: 'center', marginBottom: '20px' }}>
                  <h1 style={{ fontSize: '24px', fontWeight: 'bold', marginBottom: '10px' }}>√âTAT DES LIEUX - {data.info.type.toUpperCase()}</h1>
                  <p style={{ fontSize: '14px', color: '#666' }}>{data.info.date}</p>
                </div>
                <div style={{ marginBottom: '20px', padding: '15px', border: '1px solid #ddd', borderRadius: '8px' }}>
                  <p><strong>Adresse:</strong> {data.info.adresse}</p>
                  <p><strong>Propri√©taire:</strong> {data.info.proprietaire}</p>
                  <p><strong>Locataire:</strong> {data.info.locataire}</p>
                </div>
                {sortedPieces.map(([pk, p]) => (
                  <div key={pk} style={{ marginBottom: '20px' }}>
                    <table style={{ width: '100%', borderCollapse: 'collapse', marginBottom: '10px' }}>
                      <thead>
                        <tr><th colSpan="3" style={{ backgroundColor: '#3b82f6', color: 'white', padding: '10px', textAlign: 'left' }}>{p.nom.toUpperCase()}</th></tr>
                        {p.etatLieux.length > 0 && <tr style={{ backgroundColor: '#f3f4f6' }}><th style={{ padding: '8px', border: '1px solid #ddd', width: '30%' }}>√âl√©ment</th><th style={{ padding: '8px', border: '1px solid #ddd', width: '15%' }}>√âtat</th><th style={{ padding: '8px', border: '1px solid #ddd' }}>Commentaire</th></tr>}
                      </thead>
                      <tbody>
                        {p.etatLieux.map(i => <tr key={i.id}><td style={{ padding: '8px', border: '1px solid #ddd' }}>{i.nom}</td><td style={{ padding: '8px', border: '1px solid #ddd', textAlign: 'center' }}><span style={{ padding: '2px 8px', borderRadius: '4px', backgroundColor: i.etat === 'Bon' ? '#22c55e' : i.etat === 'Appropri√©' ? '#eab308' : i.etat === 'Mauvais' ? '#ef4444' : '#9ca3af', color: 'white', fontSize: '12px' }}>{i.etat || '-'}</span></td><td style={{ padding: '8px', border: '1px solid #ddd' }}>{i.commentaire}</td></tr>)}
                      </tbody>
                    </table>
                    {p.inventaire.length > 0 && (
                      <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                        <thead><tr style={{ backgroundColor: '#f3f4f6' }}><th style={{ padding: '8px', border: '1px solid #ddd', width: '30%' }}>Inventaire</th><th style={{ padding: '8px', border: '1px solid #ddd', width: '10%' }}>Qt√©</th><th style={{ padding: '8px', border: '1px solid #ddd', width: '15%' }}>√âtat</th><th style={{ padding: '8px', border: '1px solid #ddd' }}>Commentaire</th></tr></thead>
                        <tbody>{p.inventaire.map(i => <tr key={i.id}><td style={{ padding: '8px', border: '1px solid #ddd' }}>{i.nom}</td><td style={{ padding: '8px', border: '1px solid #ddd', textAlign: 'center' }}>{i.qte}</td><td style={{ padding: '8px', border: '1px solid #ddd', textAlign: 'center' }}><span style={{ padding: '2px 8px', borderRadius: '4px', backgroundColor: i.etat === 'Bon' ? '#22c55e' : i.etat === 'Appropri√©' ? '#eab308' : i.etat === 'Mauvais' ? '#ef4444' : '#9ca3af', color: 'white', fontSize: '12px' }}>{i.etat || '-'}</span></td><td style={{ padding: '8px', border: '1px solid #ddd' }}>{i.commentaire}</td></tr>)}</tbody>
                      </table>
                    )}
                  </div>
                ))}
                <div style={{ marginBottom: '20px' }}>
                  <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                    <thead>
                      <tr><th colSpan="4" style={{ backgroundColor: '#3b82f6', color: 'white', padding: '10px', textAlign: 'left' }}>CL√âS</th></tr>
                      <tr style={{ backgroundColor: '#f3f4f6' }}><th style={{ padding: '8px', border: '1px solid #ddd', width: '30%' }}>Cl√©</th><th style={{ padding: '8px', border: '1px solid #ddd', width: '10%' }}>Qt√©</th><th style={{ padding: '8px', border: '1px solid #ddd', width: '15%' }}>Rendue</th><th style={{ padding: '8px', border: '1px solid #ddd' }}>Commentaire</th></tr>
                    </thead>
                    <tbody>{data.cles.map(c => <tr key={c.id}><td style={{ padding: '8px', border: '1px solid #ddd' }}>{c.nom}</td><td style={{ padding: '8px', border: '1px solid #ddd', textAlign: 'center' }}>{c.qte}</td><td style={{ padding: '8px', border: '1px solid #ddd', textAlign: 'center' }}><span style={{ padding: '2px 8px', borderRadius: '4px', backgroundColor: c.rendue === 'Oui' ? '#22c55e' : c.rendue === 'Non' ? '#ef4444' : '#9ca3af', color: 'white', fontSize: '12px' }}>{c.rendue || '-'}</span></td><td style={{ padding: '8px', border: '1px solid #ddd' }}>{c.commentaire}</td></tr>)}</tbody>
                  </table>
                </div>
                <div className="signatures-block" style={{ marginTop: '40px', pageBreakInside: 'avoid' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                    <div style={{ width: '45%', textAlign: 'center' }}><p style={{ fontWeight: 'bold', marginBottom: '10px' }}>Le Locataire</p><p style={{ marginBottom: '40px' }}>{data.signatures.locataire}</p><div style={{ borderTop: '1px solid #000', paddingTop: '5px' }}>Signature</div></div>
                    <div style={{ width: '45%', textAlign: 'center' }}><p style={{ fontWeight: 'bold', marginBottom: '10px' }}>Le Propri√©taire</p><p style={{ marginBottom: '40px' }}>{data.signatures.proprietaire}</p><div style={{ borderTop: '1px solid #000', paddingTop: '5px' }}>Signature</div></div>
                  </div>
                </div>
              </div>
            )}
          </div>
        </AppContext.Provider>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
